#작업 브랜치별 미리보기 환경 제공 및 자동 삭제 기능
#트리거:
#      (미리보기 환경 생성) -> develop 브랜치에 PR 생성
#      (미리보기 환경 삭제) -> 해당 PR close

name: PR Preview Deployment

on:
    pull_request:
        types:
            - opened
            - synchronize
            - closed
        branches:
            - develop # ✅ develop 브랜치 대상 PR에서만 실행

jobs:
    amplify-preview:
        runs-on: ubuntu-latest
        steps:
            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v1
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: us-east-2 # ✅ Amplify 리전

            - name: Set Variables
              id: vars
              run: |
                  PR_BRANCH="${{ github.head_ref }}"  # ✅ PR의 원본 작업 브랜치
                  AMPLIFY_APP_ID="db4dsu24cdkm9" 

                  # 슬래시(`/`)를 하이픈(`-`)으로 변환
                  SAFE_BRANCH_NAME=$(echo "$PR_BRANCH" | tr '/' '-')

                  PREVIEW_URL="https://${SAFE_BRANCH_NAME}.${AMPLIFY_APP_ID}.amplifyapp.com"

                  echo "PR_BRANCH=$PR_BRANCH" >> $GITHUB_ENV
                  echo "SAFE_BRANCH_NAME=$SAFE_BRANCH_NAME" >> $GITHUB_ENV
                  echo "AMPLIFY_APP_ID=$AMPLIFY_APP_ID" >> $GITHUB_ENV
                  echo "PREVIEW_URL=$PREVIEW_URL" >> $GITHUB_ENV

            - name: Create and Deploy Preview Environment (PR Opened or Updated)
              if: github.event.action != 'closed'
              run: |
                  # 변환된 브랜치명을 사용하여 AWS Amplify에 등록
                  aws amplify create-branch --app-id $AMPLIFY_APP_ID --branch-name $SAFE_BRANCH_NAME --enable-auto-build

                  # 배포 트리거
                  aws amplify start-job --app-id $AMPLIFY_APP_ID --branch-name $SAFE_BRANCH_NAME --job-type RELEASE

            - name: Comment Preview URL on PR
              if: github.event.action != 'closed'
              uses: actions/github-script@v6
              with:
                  github-token: ${{ secrets.ACTION_TOKEN }}
                  script: |
                      const previewUrl = process.env.PREVIEW_URL;
                      const comment = `🚀 **Preview Environment Ready!**\n\n🔗 [**Click here to view the preview**](${previewUrl})\n\n🛠️ This preview environment will be deleted when the PR is merged.`;
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: comment
                      });

    amplify-cleanup:
        runs-on: ubuntu-latest
        if: github.event.action == 'closed'
        steps:
            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v1
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: us-east-2

            - name: Delete Preview Environment (PR Merged or Closed)
              run: |
                  PR_BRANCH="${{ github.head_ref }}"  # ✅ PR 작업 브랜치
                  AMPLIFY_APP_ID="db4dsu24cdkm9" 

                  # 슬래시(`/`)를 하이픈(`-`)으로 변환
                  SAFE_BRANCH_NAME=$(echo "$PR_BRANCH" | tr '/' '-')

                  # 브랜치 삭제
                  aws amplify delete-branch --app-id $AMPLIFY_APP_ID --branch-name $SAFE_BRANCH_NAME
