name: PR Preview Deployment

on:
    pull_request:
        types:
            - opened
            - synchronize
            - closed
        branches:
            - develop # âœ… develop ë¸Œëœì¹˜ ëŒ€ìƒ PRì—ì„œë§Œ ì‹¤í–‰

jobs:
    amplify-preview:
        runs-on: ubuntu-latest
        steps:
            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v1
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: us-east-2

            - name: Set Variables
              id: vars
              run: |
                  PR_BRANCH="${{ github.head_ref }}"  # âœ… PRì˜ ì‘ì—… ë¸Œëœì¹˜
                  AMPLIFY_APP_ID="db4dsu24cdkm9"  # âœ… AWS Amplify ì•± ID (ìˆ˜ì • í•„ìš”)
                  echo "PR_BRANCH=$PR_BRANCH" >> $GITHUB_ENV
                  echo "AMPLIFY_APP_ID=$AMPLIFY_APP_ID" >> $GITHUB_ENV

            - name: Create and Deploy Preview Environment (PR Opened or Updated)
              if: github.event.action != 'closed'
              run: |
                  # ì‘ì—… ë¸Œëœì¹˜ë¥¼ AWS Amplifyì— ë“±ë¡
                  aws amplify create-branch --app-id $AMPLIFY_APP_ID --branch-name $PR_BRANCH --enable-auto-build

                  # ë°°í¬ íŠ¸ë¦¬ê±°
                  aws amplify start-job --app-id $AMPLIFY_APP_ID --branch-name $PR_BRANCH --job-type RELEASE

                  # ë°°í¬ëœ í™˜ê²½ì˜ URL ê°€ì ¸ì˜¤ê¸°
                  PREVIEW_URL="https://${PR_BRANCH}.amplifyapp.com"
                  echo "PREVIEW_URL=$PREVIEW_URL" >> $GITHUB_ENV
                  echo "Preview URL: $PREVIEW_URL"

            - name: Comment Preview URL on PR
              if: github.event.action != 'closed'
              uses: actions/github-script@v6
              with:
                  github-token: ${{ secrets.ACTION_TOKEN }}
                  script: |
                      const previewUrl = process.env.PREVIEW_URL;
                      const comment = `ğŸš€ **Preview Environment Ready!**\n\nğŸ”— [**Click here to view the preview**](${previewUrl})\n\nğŸ› ï¸ This preview environment will be deleted when the PR is merged.`;
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: comment
                      });

    amplify-cleanup:
        runs-on: ubuntu-latest
        if: github.event.action == 'closed'
        steps:
            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v1
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: us-east-2

            - name: Delete Preview Environment (PR Merged or Closed)
              run: |
                  PR_BRANCH="${{ github.head_ref }}"  # âœ… PR ì‘ì—… ë¸Œëœì¹˜
                  AMPLIFY_APP_ID="db4dsu24cdkm9" 

                  # ë¸Œëœì¹˜ ì‚­ì œ
                  aws amplify delete-branch --app-id $AMPLIFY_APP_ID --branch-name $PR_BRANCH
