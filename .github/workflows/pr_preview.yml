#ì‘ì—… ë¸Œëœì¹˜ë³„ ë¯¸ë¦¬ë³´ê¸° í™˜ê²½ ì œê³µ ë° ìë™ ì‚­ì œ ê¸°ëŠ¥
#íŠ¸ë¦¬ê±°:
#      (ë¯¸ë¦¬ë³´ê¸° í™˜ê²½ ìƒì„±) -> develop ë¸Œëœì¹˜ì— PR ìƒì„±
#      (ë¯¸ë¦¬ë³´ê¸° í™˜ê²½ ì‚­ì œ) -> í•´ë‹¹ PR close

name: PR Preview Deployment

on:
    pull_request:
        types:
            - opened
            - synchronize
            - closed
        branches:
            - develop # âœ… develop ë¸Œëœì¹˜ ëŒ€ìƒ PRì—ì„œë§Œ ì‹¤í–‰

jobs:
    amplify-preview:
        runs-on: ubuntu-latest
        steps:
            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v1
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: us-east-2 # âœ… Amplify ë¦¬ì „

            - name: Set Variables
              id: vars
              run: |
                  PR_BRANCH="${{ github.head_ref }}"  # âœ… PRì˜ ì›ë³¸ ì‘ì—… ë¸Œëœì¹˜
                  AMPLIFY_APP_ID="db4dsu24cdkm9" 

                  # ìŠ¬ë˜ì‹œ(`/`)ë¥¼ í•˜ì´í”ˆ(`-`)ìœ¼ë¡œ ë³€í™˜
                  SAFE_BRANCH_NAME=$(echo "$PR_BRANCH" | tr '/' '-')

                  PREVIEW_URL="https://${SAFE_BRANCH_NAME}.${AMPLIFY_APP_ID}.amplifyapp.com"

                  echo "PR_BRANCH=$PR_BRANCH" >> $GITHUB_ENV
                  echo "SAFE_BRANCH_NAME=$SAFE_BRANCH_NAME" >> $GITHUB_ENV
                  echo "AMPLIFY_APP_ID=$AMPLIFY_APP_ID" >> $GITHUB_ENV
                  echo "PREVIEW_URL=$PREVIEW_URL" >> $GITHUB_ENV

            - name: Check if Branch Exists (Using list-branches with jq)
              id: check-branch
              run: |
                  BRANCH_EXISTS=$(aws amplify list-branches --app-id $AMPLIFY_APP_ID | jq -r '.branches[] | select(.branchName=="'"$SAFE_BRANCH_NAME"'")')

                  if [[ -n "$BRANCH_EXISTS" ]]; then
                      echo "Branch already exists in Amplify."
                      echo "EXISTS=true" >> $GITHUB_ENV
                  else
                      echo "Branch does not exist in Amplify."
                      echo "EXISTS=false" >> $GITHUB_ENV
                  fi

            - name: Create Branch if Not Exists
              if: env.EXISTS == 'false'
              run: |
                  echo "Branch does not exist. Creating..."
                  CREATE_RESULT=$(aws amplify create-branch --app-id $AMPLIFY_APP_ID --branch-name $SAFE_BRANCH_NAME --enable-auto-build 2>&1) || true

                  # "Display Name already exists" ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ ë¬´ì‹œí•˜ê³  ë„˜ì–´ê°€ê¸°
                  if echo "$CREATE_RESULT" | grep -q "display name"; then
                      echo "âš ï¸ Warning: Display name already exists. Skipping create-branch."
                  else
                      echo "âœ… Branch created successfully."
                  fi

            - name: Deploy to Amplify
              run: |
                  aws amplify start-job --app-id $AMPLIFY_APP_ID --branch-name $$PR_BRANCH --job-type RELEASE

            - name: Comment Preview URL on PR
              if: github.event.action != 'closed'
              uses: actions/github-script@v6
              with:
                  github-token: ${{ secrets.ACTION_TOKEN }}
                  script: |
                      const previewUrl = process.env.PREVIEW_URL;
                      const comment = `ğŸš€ **Preview Environment Ready!**\n\nğŸ”— [**Click here to view the preview**](${previewUrl})\n\nğŸ› ï¸ This preview environment will be deleted when the PR is merged.`;
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: comment
                      });

    amplify-cleanup:
        runs-on: ubuntu-latest
        if: github.event.action == 'closed'
        steps:
            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v1
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: us-east-2

            - name: Delete Preview Environment (PR Merged or Closed)
              run: |
                  PR_BRANCH="${{ github.head_ref }}"  # âœ… PR ì‘ì—… ë¸Œëœì¹˜
                  AMPLIFY_APP_ID="db4dsu24cdkm9" 

                  # ìŠ¬ë˜ì‹œ(`/`)ë¥¼ í•˜ì´í”ˆ(`-`)ìœ¼ë¡œ ë³€í™˜
                  SAFE_BRANCH_NAME=$(echo "$PR_BRANCH" | tr '/' '-')

                  # ë¸Œëœì¹˜ ì‚­ì œ
                  aws amplify delete-branch --app-id $AMPLIFY_APP_ID --branch-name $SAFE_BRANCH_NAME
