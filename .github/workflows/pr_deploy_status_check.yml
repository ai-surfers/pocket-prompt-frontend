name: PR Deploy Status Check

on:
    pull_request:
        branches:
            - develop # í…ŒìŠ¤íŠ¸ìš©
            - main # PR ëŒ€ìƒ ë¸Œëœì¹˜ (main)

jobs:
    check-deployment:
        runs-on: ubuntu-latest

        steps:
            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v1
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: us-east-2

            - name: Fetch AWS Amplify Deployment Status
              id: amplify-status
              run: |
                  AMPLIFY_APP_ID="db4dsu24cdkm9" # âœ… AWS Amplify ì•± ID (ìˆ˜ì • í•„ìš”)
                  BRANCH="develop" # âœ… ë°°í¬ ìƒíƒœë¥¼ ì¡°íšŒí•  ë¸Œëœì¹˜

                  # AWS Amplify ë°°í¬ ìƒíƒœ ì¡°íšŒ
                  STATUS=$(aws amplify list-jobs --app-id $AMPLIFY_APP_ID --branch-name $BRANCH --query 'jobSummaries[0].status' --output text)
                  BUILD_LOG_URL=$(aws amplify list-jobs --app-id $AMPLIFY_APP_ID --branch-name $BRANCH --query 'jobSummaries[0].logUrl' --output text)

                  # ìƒíƒœ ë©”ì‹œì§€ ìƒì„±
                  if [[ "$STATUS" == "SUCCEED" ]]; then
                      COMMENT="âœ… **Latest Deploy on AWS Amplify Passed!** ğŸ‰\n\nğŸš€ The latest deployment for \`$BRANCH\` branch was **successful**.\n[ğŸ” View Logs]($BUILD_LOG_URL)"
                  elif [[ "$STATUS" == "FAILED" ]]; then
                      COMMENT="âŒ **Latest Deploy on AWS Amplify Failed!** ğŸš¨\n\nğŸ›‘ The latest deployment for \`$BRANCH\` branch **failed**.\n[ğŸ” View Logs]($BUILD_LOG_URL)"
                  else
                      COMMENT="â³ **AWS Amplify Deployment in Progress...** ğŸ”„\n\nğŸ” The latest deployment for \`$BRANCH\` branch is still in progress.\n[ğŸ” View Logs]($BUILD_LOG_URL)"
                  fi

                  echo "$COMMENT" > amplify_status.txt

            - name: Comment Deployment Status on PR
              uses: actions/github-script@v6
              with:
                  github-token: ${{ secrets.ACTION_TOKEN }} # âœ… GitHub Actionsì—ì„œ ì‚¬ìš©í•  í† í°
                  script: |
                      const fs = require('fs');
                      const statusMessage = fs.readFileSync('amplify_status.txt', 'utf8');

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: statusMessage
                      });
