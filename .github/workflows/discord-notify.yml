name: Discord Notification on Push
on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # 1. ì´ ì»¤ë°‹ê³¼ ì—°ê²°ëœ(ë¨¸ì§€ëœ) PR ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê¸°
      - name: Get Pull Request Info
        id: prinfo
        uses: actions/github-script@v6
        with:
          script: |
            const response = await github.request('GET /repos/${{ context.repo.owner }}/${{ context.repo.repo }}/commits/${{ context.sha }}/pulls');
            core.setOutput("data", JSON.stringify(response.data));

      # 2. Discordë¡œ ì•Œë¦¼ ë³´ë‚´ê¸°
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          PR_TITLE=$(echo '${{ steps.prinfo.outputs.data }}' | jq -r '.[0].title // ""')
          PR_LINK=$(echo '${{ steps.prinfo.outputs.data }}' | jq -r '.[0].html_url // ""')

          if [ "$PR_TITLE" = "" ] || [ "$PR_TITLE" = "null" ]; then
            MSG="ğŸš€ ì½”ë“œê°€ main ë¸Œëœì¹˜ì— ë°”ë¡œ pushë˜ì—ˆìŠµë‹ˆë‹¤! PR ì—†ì´ ì˜¬ë¼ê°„ ì»¤ë°‹ì´ë¯€ë¡œ í™•ì¸í•´ì£¼ì„¸ìš”. ğŸ“Œ\n**ì½”ë“œ í™•ì¸**: https://github.com/${{ github.repository }}/tree/main"
          else
            MSG="ğŸš€ ì½”ë“œê°€ main ë¸Œëœì¹˜ì— pushë˜ì—ˆìŠµë‹ˆë‹¤!\n**PR ì œëª©**: ${PR_TITLE}\n**PR ë§í¬**: ${PR_LINK}"
          fi

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"${MSG}\"}" \
               "$DISCORD_WEBHOOK"
