name: Discord Notification on Push
on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # 1. ì´ ì»¤ë°‹ê³¼ ì—°ê²°ëœ(ë¨¸ì§€ëœ) PR ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê¸°
      - name: Get Pull Request Info
        id: prinfo
        uses: octokit/request-action@v2
        with:
          route: GET /repos/${{ github.repository }}/commits/${{ github.sha }}/pulls
          mediaType: 'format=json'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 2. Discordë¡œ ì•Œë¦¼ ë³´ë‚´ê¸°
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          PR_TITLE=$(echo '${{ steps.prinfo.outputs.data }}' | jq -r '.[0].title // ""')
          PR_LINK=$(echo '${{ steps.prinfo.outputs.data }}' | jq -r '.[0].html_url // ""')

          # ë¨¸ì§€ëœ PRì´ ì—†ìœ¼ë©´, mainì— ì§ì ‘ pushëœ ì»¤ë°‹ìœ¼ë¡œ ê°„ì£¼
          if [ "$PR_TITLE" = "" ] || [ "$PR_TITLE" = "null" ]; then
            MSG="ğŸš€ ì½”ë“œê°€ main ë¸Œëœì¹˜ì— ë°”ë¡œ pushë˜ì—ˆìŠµë‹ˆë‹¤! PR ì—†ì´ ì˜¬ë¼ê°„ ì»¤ë°‹ì´ë¯€ë¡œ í™•ì¸í•´ì£¼ì„¸ìš”. ğŸ“Œ\n**ì½”ë“œ í™•ì¸**: https://github.com/${{ github.repository }}/tree/main"
          else
            MSG="ğŸš€ ì½”ë“œê°€ main ë¸Œëœì¹˜ì— pushë˜ì—ˆìŠµë‹ˆë‹¤!\n**PR ì œëª©**: ${PR_TITLE}\n**PR ë§í¬**: ${PR_LINK}"
          fi

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"${MSG}\"}" \
               "$DISCORD_WEBHOOK"
