\name: PR Build Check

on:
    pull_request:
        branches:
            - develop # PR ëŒ€ìƒ ë¸Œëœì¹˜

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            # âœ… ì‘ì—… ë¸Œëœì¹˜ ê¸°ì¤€ìœ¼ë¡œ ì„œë¸Œëª¨ë“ˆ í¬í•¨ ì²´í¬ì•„ì›ƒ
            - name: Checkout source branch with submodules
              uses: actions/checkout@v3
              with:
                  ref: ${{ github.head_ref }} # ì‘ì—… ë¸Œëœì¹˜ ê¸°ì¤€
                  submodules: recursive # âœ… ì„œë¸Œëª¨ë“ˆê¹Œì§€ ì²´í¬ì•„ì›ƒ
                  fetch-depth: 0 # âœ… ì „ì²´ ì»¤ë°‹ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°

            # âœ… ì„œë¸Œëª¨ë“ˆ ì´ˆê¸°í™” ë° ì—…ë°ì´íŠ¸
            - name: Initialize and update submodules
              run: git submodule update --init --recursive

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "18"

            - name: Install dependencies
              run: yarn install

            # ğŸ” íƒ€ì… ì²´í¬
            - name: Type Check
              run: tsc --noEmit || echo "âŒ Type Check Failed" >> build_output.txt

            # ğŸ§¹ Linter ì‹¤í–‰
            - name: Run Linter
              run: yarn lint || echo "âŒ Linting Failed" >> build_output.txt

            # âš™ï¸ ë¹Œë“œ ì‹¤í–‰
            - name: Run next build
              id: build
              run: |
                  yarn build >> build_output.txt 2>&1 || echo "âŒ Build Failed" >> build_output.txt

            # ğŸš€ ëŸ°íƒ€ì„ ì²´í¬ (ì„ íƒ)
            - name: Start App to Check Runtime Errors
              run: |
                  yarn start &
                  sleep 10
                  curl -f http://localhost:3000 || echo "âŒ Runtime Error Detected" >> build_output.txt

            # ğŸ’¬ PR ì½”ë©˜íŠ¸ë¡œ ê²°ê³¼ ë‚¨ê¸°ê¸°
            - name: Comment Build Result
              uses: actions/github-script@v6
              with:
                  github-token: ${{ secrets.ACTION_TOKEN }} # âœ… ì»¤ìŠ¤í…€ í† í° ì‚¬ìš©
                  script: |
                      const fs = require('fs');
                      const buildLog = fs.readFileSync('build_output.txt', 'utf8');
                      const success = buildLog.includes("Compiled successfully") && !buildLog.includes("âŒ");

                      let comment = "";
                      if (success) {
                        comment = "âœ… **Build Passed!** ğŸ‰\n\n```\n" + buildLog.slice(-500) + "\n```";
                      } else {
                        comment = "âŒ **Build Failed!** ğŸš¨\n\n### ğŸ” Error Details:\n```\n" + buildLog.slice(-1000) + "\n```";
                      }

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: comment
                      });
